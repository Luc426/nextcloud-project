apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: devnet

labels:
- includeSelectors: true
  pairs:
    app: cloud
    env: test

resources:
- storage/
- jobs/
- mariadb/
- secrets/
- ingress/
- configmap/
- ../../base

# configMapGenerator:
# - name: config-php
#   files:
#   - config/config.php

patches:
- target:
    kind: Deployment
    # name of the deployment to patch:
    name: php    
  # Updating PVCs name
  patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: php
    spec:
      replicas: 1
      template:
        metadata:
          labels:
            app: cloud
            env: prod
            tier: backend
        spec:
          volumes:
          - name: webcontent
            persistentVolumeClaim:
              claimName: www-devnet-pvc
          - name: user-data
            persistentVolumeClaim:
              claimName: userdata-devnet-pvc
- target:
    kind: Deployment
    name: nginx
  # Updating PVCs name
  patch: |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: nginx
    spec:
      template:
        metadata:
          labels:
            app: cloud
            env: prod
            tier: frontend
        spec:
          volumes:
          - name: webcontent
            persistentVolumeClaim:
              claimName: www-devnet-pvc
          - name: user-data
            persistentVolumeClaim:
              claimName: userdata-devnet-pvc
- target:
    kind: CronJob
    name: cron
  # Updating PVCs name
  patch: |-
    apiVersion: apps/v1
    kind: CronJob
    metadata:
      name: cron
    spec:
      jobTemplate:
        spec:
          template:
            metadata:
              labels:
                app: cloud
                env: test
            spec:
              volumes:
                - name: webcontent
                  persistentVolumeClaim:
                    claimName: www-devnet-pvc
                - name: user-data
                  persistentVolumeClaim:
                    claimName: userdata-devnet-pvc
---
